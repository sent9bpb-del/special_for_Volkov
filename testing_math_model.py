import matplotlib.pyplot as plt  # библиотека для построения графиков
import numpy as np               # библиотека для численных вычислений и работы с массивами

# --- Константы и параметры модели ---

R = 8.31        # универсальная газовая постоянная, Дж/(моль·К)
A1 = 50         # предэкспоненциальный множитель для первой реакции
E1 = 64000      # энергия активации первой реакции, Дж/моль
A2 = 10         # предэкспоненциальный множитель для второй реакции
E2 = 44000      # энергия активации второй реакции, Дж/моль
A3 = 10**6      # предэкспоненциальный множитель для третьей реакции
E3 = 108000     # энергия активации третьей реакции, Дж/моль
A4 = 25 * 10**5 # предэкспоненциальный множитель для четвертой реакции
E4 = 112000     # энергия активации четвертой реакции, Дж/моль

m_c1_vh = 0.28  # массовая доля метанола на входе
m_vozd_vh = 0.28  # массовая доля воздуха на входе

ro = 1.6        # плотность газовой смеси, кг/м^3

V = 3           # объем реакционного аппарата, м^3
T = 900         # температура процесса, К

# Молярные массы веществ, кг/моль
mu_ch3oh = 0.032  # метанол CH3OH
mu_o2 = 0.032     # кислород O2 (для данной модели принято такое же значение)
mu_hcho = 0.030   # формальдегид HCHO
mu_h2 = 0.002     # водород H2

t0 = 0          # начальное время, с
d_t = 0.01      # шаг по времени, с
eps = 0.01      # допуск для критериев стационарности (по концентрациям в %)

# Полная массовая доля смеси на входе (метанол + воздух)
m = m_c1_vh + m_vozd_vh


# --- Вспомогательные функции ---

def k(A, E, T):
    """
    Расчет константы скорости реакции по уравнению Аррениуса.
    A - предэкспоненциальный множитель,
    E - энергия активации,
    T - температура (K).
    """
    k = A * np.exp(-E / (R * T))
    return k


def per_C(C_m, mu):
    """
    Перевод концентрации из моль/м^3 в массовую долю в процентах.
    C_m - концентрация в моль/м^3,
    mu - молярная масса вещества, кг/моль.
    """
    C = (C_m * 100 * mu) / ro
    return C


def t_s(V):
    """
    Время пребывания газа в реакторе.
    V - объем аппарата.
    v - удельный объем (масса / плотность).
    """
    v = m / ro
    t_s = V / v
    return t_s


# --- Правая часть системы дифференциальных уравнений для концентраций ---

def f_C1(C1_vh, C1, C3, C4):
    """
    Уравнение для изменения концентрации метанола C1.

    Члены:
    - (1/t_s)*(C1_vh - C1) — приток/отток по материалному балансу (вход-выход),
    - остальные — расход метанола в химических реакциях 1–4.
    """
    C1 = (1 / t_s(V)) * (C1_vh - C1) \
         - 2 * k(A1, E1, T) * C1 * C3 \
         - k(A2, E2, T) * C1 \
         - 2 * k(A3, E3, T) * C1 * C3 \
         - k(A4, E4, T) * C1 * C4
    return C1


def f_C2(C2_vh, C2, C1, C3):
    """
    Уравнение для изменения концентрации формальдегида C2.

    Члены:
    - (1/t_s)*(C2_vh - C2) — приток/отток по материальному балансу,
    - + 2*k1*C1*C3 и + k2*C1 — образование формальдегида в реакциях.
    """
    C2 = (1 / t_s(V)) * (C2_vh - C2) \
         + 2 * k(A1, E1, T) * C1 * C3 \
         + k(A2, E2, T) * C1
    return C2


def f_C3(C3_vh, C3, C1):
    """
    Уравнение для изменения концентрации кислорода C3.

    Члены:
    - (1/t_s)*(C3_vh - C3) — приток/отток,
    - -k1*C1*C3 и -3*k3*C1*C3 — расход кислорода в реакциях.
    """
    C3 = (1 / t_s(V)) * (C3_vh - C3) \
         - k(A1, E1, T) * C1 * C3 \
         - 3 * k(A3, E3, T) * C1 * C3
    return C3


def f_C4(C4_vh, C4, C1):
    """
    Уравнение для изменения концентрации водорода C4.

    Члены:
    - (1/t_s)*(C4_vh - C4) — приток/отток,
    - -k4*C1*C4 — расход в реакции,
    - +k2*C1 — образование как побочного продукта другой реакции.
    """
    C4 = (1 / t_s(V)) * (C4_vh - C4) \
         - k(A4, E4, T) * C1 * C4 \
         + k(A2, E2, T) * C1
    return C4


# --- Начальные концентрации на входе (в моль/м^3) ---

# Метанол на входе (через массовую долю, плотность и молярную массу)
C1_vh = (m_c1_vh * ro) / (m * mu_ch3oh)
# Кислород на входе: берем 22% O2 в воздухе по объему (в модели через массовую долю)
C3_vh = (m_vozd_vh * 0.22 * ro) / (m * mu_o2)
C2_vh = 0  # формальдегид изначально отсутствует
C4_vh = 0  # водород изначально отсутствует

# Начальные концентрации в реакторе (принимаем равными входным)
C1 = C1_vh
C2 = C2_vh
C3 = C3_vh
C4 = C4_vh

# --- Массивы для хранения результатов во времени ---

C1_array = [C1]  # концентрация CH3OH, моль/м^3
C2_array = [C2]  # концентрация HCHO, моль/м^3
C3_array = [C3]  # концентрация O2, моль/м^3
C4_array = [C4]  # концентрация H2, моль/м^3

# Те же концентрации, переведенные в массовые доли, %
C1_per_array = [per_C(C1, mu_ch3oh)]
C2_per_array = [per_C(C2, mu_hcho)]
C3_per_array = [per_C(C3, mu_o2)]
C4_per_array = [per_C(C4, mu_h2)]

t_array = [t0]  # массив времени, с

# Вывод концентраций на входе в удобном виде
print(f"Концентрация метанола (CH3OH) на входе: {C1_array[0]} моль/м^3, {C1_per_array[0]} %")
print(f"Концентрация кислорода (O2) на входе: {C3_array[0]} моль/м^3, {C3_per_array[0]} %")


# --- Численное интегрирование по времени до достижения стационарного режима ---

while True:
    # Явная схема Эйлера для каждой концентрации:
    C1 += f_C1(C1_vh, C1_array[-1], C3_array[-1], C4_array[-1]) * d_t
    C2 += f_C2(C2_vh, C2_array[-1], C1_array[-1], C3_array[-1]) * d_t
    C3 += f_C3(C3_vh, C3_array[-1], C1_array[-1]) * d_t
    C4 += f_C4(C4_vh, C4_array[-1], C1_array[-1]) * d_t
    t0 += d_t  # увеличиваем текущее время

    # Сохраняем новые значения в массивах
    C1_array.append(C1)
    C2_array.append(C2)
    C3_array.append(C3)
    C4_array.append(C4)
    C1_per_array.append(per_C(C1, mu_ch3oh))
    C2_per_array.append(per_C(C2, mu_hcho))
    C3_per_array.append(per_C(C3, mu_o2))
    C4_per_array.append(per_C(C4, mu_h2))
    t_array.append(t0)

    # Критерий стационарности:
    # разность концентраций (в %) на двух последних шагах по модулю меньше eps для всех веществ
    if (abs(C1_per_array[-1] - C1_per_array[-2]) < eps) and \
       (abs(C2_per_array[-1] - C2_per_array[-2]) < eps) and \
       (abs(C3_per_array[-1] - C3_per_array[-2]) < eps) and \
       (abs(C4_per_array[-1] - C4_per_array[-2]) < eps):
        break  # выходим из цикла, считаем режим установившимся

# Вывод стационарных значений на выходе
print(f"Концентрация формальдегида (HCHO) на выходе: {C2_array[-1]} моль/м^3, {C2_per_array[-1]} %")
print(f"Время достижения стационарного режима: {t_array[-1]} c")

# --- Построение графиков изменения концентраций во времени ---

plt.figure(figsize=(15, 5))  # общий размер окна с графиками

# График по метанолу CH3OH
plt.subplot(1, 3, 1)  # первый график из трех
plt.plot(t_array, C1_per_array)  # зависимость массовой доли CH3OH от времени
plt.grid(True)
plt.xlabel('$t, c$')
plt.ylabel('C1 (CH3OH), %')
plt.axhline(0, color='black', linewidth=1)  # ось X
plt.axvline(0, color='black', linewidth=1)  # ось Y

# График по кислороду O2
plt.subplot(1, 3, 2)  # второй график
plt.plot(t_array, C3_per_array)  # зависимость массовой доли O2 от времени
plt.grid(True)
plt.xlabel('$t, c$')
plt.ylabel('C3 (O2), %')
plt.axhline(0, color='black', linewidth=1)
plt.axvline(0, color='black', linewidth=1)

# График по формальдегиду HCHO
plt.subplot(1, 3, 3)  # третий график
plt.plot(t_array, C2_per_array)  # зависимость массовой доли HCHO от времени
plt.grid(True)
plt.xlabel('$t, c$')
plt.ylabel('C2 (HCHO), %')
plt.axhline(0, color='black', linewidth=1)
plt.axvline(0, color='black', linewidth=1)

plt.tight_layout()  # аккуратно разложить графики, чтобы они не перекрывались
plt.show()          # отобразить окно с графиками
